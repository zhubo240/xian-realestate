# 数据质量审查报告

**审查时间**: 2026-02-10
**审查对象**: xian-realestate 项目全数据管道（爬虫 → 地理编码 → 合并 → 可视化）
**数据集**: 645条记录（523二手房 + 171新房，去重后645）

---

## 一、数据错误

### 1.1 坐标跑到其他城市（严重，6条）

POI搜索匹配到了外地同名项目，导致坐标完全错误：

- **CCmall** → 实际指向乌鲁木齐（标注为软件新城）
- **万科云谷** → 实际指向宁波（标注为其他）
- **阅山境** → 实际指向深圳（标注为高新三期）
- **九树公寓** → 实际指向杭州（标注为高新二期）
- **GX3-26-37** → 实际指向武汉（标注为高新三期）
- **半岛上苑** → 实际指向河南（标注为高新三期）

**根因**: `poi_search()` 只指定了 `region: "西安"`，但高德API在匹配不到西安结果时会返回其他城市的同名POI，代码直接取了第一个结果，没有验证返回坐标是否在西安范围内。

**修复建议**: 对POI搜索结果做坐标范围校验（西安高新区大致范围 lng 108.80-109.05, lat 34.10-34.30），超出范围的标记为失败。

### 1.2 占位坐标/默认值（严重，~31条）

地理编码失败后使用了默认坐标，导致多个小区堆叠在同一个点上：

- 15个小区共享坐标 (108.883689, 34.227024)
- 6个共享 (108.835248, 34.183757)
- 10个共享 (108.813475, 34.134325)

**根因**: 高德Geocoding API在模糊匹配时返回了区域中心点坐标，而非具体小区位置。代码没有区分"精确匹配"和"区域级匹配"。

**修复建议**: 检测重复坐标（同一坐标出现3次以上），标记为"坐标不可靠"。在地图上用不同样式（如灰色/虚线标记）区分。

### 1.3 片区分类与实际位置矛盾（中等，~47条）

关键词匹配规则不够精确，导致标注片区与坐标实际位置不一致：

- 万达天樾坐标在二期区域（lat 34.196），却被分到一期
- 多个GX3系列地块坐标在一期区域，却被标为三期
- 二手房和新房使用了两套不同的分类规则（一个基于板块名，一个基于地址文本），进一步加剧不一致

**根因**: `classify_zone()` 函数基于文本关键词匹配（板块名或地址中的路名），而非基于坐标落点判断。两个脚本（`geocode_communities.py` 和 `geocode_newhouse.py`）的分类关键词列表也不一致。

**修复建议**: 改为基于坐标的空间判断（point-in-polygon），使用片区边界多边形判断每个点属于哪个片区。

### 1.4 重复/近重复数据（中等，~27组）

- 保利天悦悦峰 和 保利·天悦 — 坐标完全相同，实为同一楼盘
- 启迪中心 — 出现了3次
- 其他类似情况约25组

**根因**: 二手房和新房数据合并时，只做了精确名称匹配去重，没有处理名称变体（如"·"、空格差异、简称/全称差异）。

**修复建议**: 合并时使用模糊匹配（如编辑距离 ≤ 2 或去除标点后比较），同时检测坐标距离 < 50米的不同名称记录。

---

## 二、地图渲染Bug

### 2.1 高优先级

- **"国际社区"按钮选中状态失效**: `setZone()` 函数中的字符串替换逻辑 `zone.replace('高新','').replace('新城','').replace('社区','')` 把"国际社区"变成了"国际"，但按钮文本是"社区"，`'社区'.includes('国际')` 为 false，导致按钮永远不会高亮
- **38.6%的标记落在所有片区边界多边形之外**: 249/645个标记位于所有已定义多边形之外，说明多边形覆盖范围不够大
- **价格筛选静默丢弃无价格数据**: 设置任何价格范围后，201个价格为null的记录（31%）被直接过滤掉，用户无感知

### 2.2 中优先级

- **在售0套显示为"-"**: JS中 `d.u ? d.u + ' 套' : '-'` 把0当作falsy，283个在售0套的项目显示为"-"而非"0 套"
- **片区多边形互相重叠**: 高新一期/二期边界区域、高新二期/软件新城边界区域存在重叠，视觉上容易混淆
- **OSM地图版权信息不完整**: 缺少链接和"contributors"字样，不符合OSM使用政策

### 2.3 低优先级

- 项目名称未做HTML转义，存在潜在XSS风险
- 红色/橙色标记对色盲用户不友好
- 价格筛选最大值输入0时因JS falsy问题等同于无限大
- 片区按钮选择器使用硬编码 `nth-child(5)`，DOM变化会导致失效
- `makeIcon()` 中存在未使用的变量（dead code）

---

## 三、数据管道根因分析

### 3.1 爬虫层 (scrape_gaoxin_esf.py)

- **正则解析脆弱**: 依赖fang.com的HTML结构，页面改版会导致数据丢失或解析错误
- **无去重**: 不同页面出现同一小区时会重复记录
- **仅挂牌价**: 均价为挂牌均价，非成交价，系统性偏高10-20%
- **非随机抽样**: 按热度/在售量排序，可能遗漏冷门小区

### 3.2 地理编码层 (geocode_communities.py / geocode_newhouse.py)

- **GCJ-02→WGS-84用固定偏移量**: `lng - 0.0065, lat - 0.0060` 是西安区域的近似值，实际偏移量因坐标不同而异，可能导致50-200米误差
- **POI搜索无城市约束验证**: 取第一个返回结果，不验证是否在西安
- **两套脚本分类规则不一致**: 二手房用板块名分类，新房用地址文本分类，关键词列表也不同

### 3.3 合并层 (merge_and_map.py)

- **去重不够智能**: 仅精确名称匹配，不处理名称变体
- **片区多边形过于简化**: 4-7个顶点的粗略多边形，远不能准确表示实际片区边界

---

## 四、验证与改进建议

### 立刻可做

1. **坐标范围校验**: 过滤掉 lng/lat 不在西安范围内的记录
2. **重复坐标检测**: 找出共享同一坐标的记录组，标记为不可靠
3. **去重**: 对名称做标准化后去重（去标点、去空格、去"·"）
4. **修复地图JS bug**: 国际社区按钮、价格筛选、0套显示

### 中期改进

5. **精确坐标转换**: 用开源 coordTransform 库替换固定偏移
6. **基于坐标的片区分类**: point-in-polygon 空间判断替代关键词匹配
7. **POI结果验证**: 检查返回坐标是否在目标区域内
8. **扩大片区多边形**: 使用更精确的边界数据

### 长期建设

9. **多源交叉验证**: 同时采集链家/贝壳数据，对比价格和覆盖
10. **成交价数据**: 引入真实成交数据替代挂牌价
11. **官方数据源**: 西安住建局备案价作为价格验证基准
12. **定时采集**: 建立时间序列，追踪价格变化趋势

---

*报告由 Claude Code 自动生成*
